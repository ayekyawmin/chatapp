<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>mkctl</title>
    <style>
body { 
  margin: 0; 
  padding-bottom: 3rem; 
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
}
      
      #container {
  display: flex;
  flex-direction: column;
}

#form { 
  background: rgba(0, 0, 0, 0.15); 
  padding: 0.25rem; 
  position: fixed; 
  bottom: 0; 
  left: 0; 
  right: 0; 
  display: flex; 
  flex-direction: column; /* Stack items vertically */
  align-items: center; /* Center items horizontally */
  height: auto; /* Allow form to expand vertically */
  box-sizing: border-box; 
  backdrop-filter: blur(10px); 
}

#input { 
  border: none; 
  padding: 0 1rem; 
  border-radius: 2rem; 
  margin: 0.25rem; 
  display: none;
}

#input:focus { 
  outline: none; 
}

#mydiv > button { 
  background: #333; 
  border: none; 
  padding: 0.5rem 1rem; 
  margin: 0.25rem; 
  border-radius: 3px; 
  outline: none; 
  color: #fff; 
  display: none;
}

#messages { 
  list-style-type: none; 
  margin: 0; 
  padding: 0; 
}

#messages > li { 
  padding: 0.5rem 1rem; 
}

.timestamp { 
  font-size: 0.6em; 
  color: gray; 
}

#file-name {
  display: none;
}

#file-input {
  display: none;
}

#image-preview {
  width: 100px;
  height: 100px;
  overflow: hidden;
  margin-top: 10px;
}

#image-preview img {
  width: 100%;
  height: auto;
}

#password-form { 
  background: rgba(0, 0, 0, 0.15); 
  padding: 1rem; 
  position: fixed; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%); 
  display: flex; 
  flex-direction: column;
  align-items: center;
  border-radius: 10px;
}

#password-input { 
  border: none; 
  padding: 0.5rem; 
  margin-bottom: 1rem;
  border-radius: 5px;
}

#password-submit { 
  background: #333; 
  border: none; 
  padding: 0.5rem 1rem; 
  margin: 0.25rem; 
  border-radius: 3px; 
  outline: none; 
  color: #fff; 
  cursor: pointer;
}

@media only screen and (max-width: 600px) {
  #input {
    padding: 0.5rem; /* Increase padding for better touch input */
  }

  #form {
    height: auto; /* Allow form to expand vertically on smaller screens */
    flex-direction: column; /* Stack items vertically */
  }

  #form > button {
    margin: 0.25rem 0; /* Add margin to separate buttons vertically */
  }
}




    </style>
  </head>
  <body>

    <div id="container">
      <ul id="messages" style="display: none;"></ul>

      <div id="usage-indicator" style="height:3rem; color:gray; font-style: italic; margin-left: 1rem;"></div> <!-- App usage indicator -->
      <div id="typing-indicator" style="height:3rem; color:gray; font-style: italic; margin-left: 1rem;"></div> <!-- New element to display typing indicator -->
 
<form id="form" action="" style="display: none; display: flex; flex-direction: column;">
  <input id="input" autocomplete="off" style="margin-bottom: 0.5rem; width:100%;" />
  <div id="mydiv" style="justify-content: space-between;">
      
    <!-- Hidden file input -->
    <input type="file" accept="image/*" id="file-input" multiple style="display: none;">
    <button style="flex-grow: 1;">Text</button> 
    <!-- Custom button for selecting files -->
    <button id="startButton" >Video</button>
    <button id="select-button" >Photo</button>
    
    
  </div>
</form>

   

    <form id="password-form">
      <input id="password-input" type="password" placeholder="Go to Signal">
      <button id="password-submit">Submit</button>
    </form>
</div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io({
        auth: {
          serverOffset: 0
        }
      });

      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');
      const typingIndicator = document.getElementById('typing-indicator');
      const usageIndicator = document.getElementById('usage-indicator');
      const myconst = document.getElementById('mydiv');
      const myinput = document.getElementById('input');

      const passwordForm = document.getElementById('password-form');
  const passwordInput = document.getElementById('password-input');
  const passwordSubmit = document.getElementById('password-submit');
  const passwordError = document.getElementById('password-error');



  // Function to show main form and hide password form
  const showMainForm = () => {
    form.style.display = 'flex';
    passwordForm.style.display = 'none';
    messages.style.display = 'block';
    mydiv.style.display = 'block';
    mydiv.style.display = 'flex';
    myinput.style.display = 'block';
  };

  // Event listener for password form submission
  passwordSubmit.addEventListener('click', (e) => {
    e.preventDefault();
    const enteredPassword = passwordInput.value.trim();
    const correctPassword = 'chital'; // Replace with your predefined password
    if (enteredPassword === correctPassword) {
      showMainForm(); // Show the main form if the password is correct
    } else {
      passwordError.style.display = 'block'; // Display error message if the password is incorrect
    }
  });




      // Function to display typing indicator
      const displayTypingIndicator = (text) => {
        typingIndicator.textContent = text;
      };

      // Function to clear typing indicator
      const clearTypingIndicator = () => {
        typingIndicator.textContent = '';
      };

      // Function to emit typing events
      const emitTypingEvent = () => {
        socket.emit('typing', true);
      };

      // Function to emit stop typing events
      const emitStopTypingEvent = () => {
        socket.emit('typing', false);
      };




      // Event listener for input events
      input.addEventListener('input', () => {
        if (input.value) {
          emitTypingEvent();
        } else {
          emitStopTypingEvent();
        }
      });

      // Event listener for file input change
      const fileInput = document.getElementById('file-input');
      const selectButton = document.getElementById('select-button');


      selectButton.addEventListener('click', function() {
        fileInput.click(); // Trigger click event on the hidden file input
      });

      fileInput.addEventListener('change', function(event) {
  const files = event.target.files;
  for (const file of files) {
    const reader = new FileReader();
    reader.onload = function() {
      const image = new Image();
      image.src = reader.result;
      image.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        // Set canvas dimensions to 10% of the original image size
        canvas.width = image.width * 0.9;
        canvas.height = image.height * 0.9;
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
        // Convert canvas content back to a compressed image
        canvas.toBlob(function(blob) {
          socket.emit('image message', blob); // Emit the compressed image
        }, 'image/jpeg', 0.8); // Adjust compression quality here (0.8 means 80% quality)
      };
    };
    reader.readAsDataURL(file); // Read the file as a data URL
  }
});



      socket.on('chat message', (msg, serverOffset) => {
        appendMessage(msg, serverOffset);
      });

      socket.on('image message', function(binaryData) {
        const blob = new Blob([binaryData], { type: 'image/jpeg' }); // Adjust the type based on your image type
        const imageUrl = URL.createObjectURL(blob);
        const imgPreview = document.createElement('div');
        imgPreview.id = 'image-preview';
        imgPreview.innerHTML = `<img src="${imageUrl}">`;
        messages.appendChild(imgPreview);
      });

      // Function to append message to the messages list
      function appendMessage(msg, serverOffset) {
        const item = document.createElement('li');
        item.innerHTML = msg;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
        socket.auth.serverOffset = serverOffset;
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const timestamp = new Date().toLocaleString('en-US', {
          day: 'numeric',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: true
        });
        if (input.value) {
          const messageWithTimestamp = `${input.value} <span class="timestamp">( ${timestamp} )</span>`;
          socket.emit('chat message', messageWithTimestamp);
          input.value = '';
          emitStopTypingEvent();
        }
      });


      // Handle 'typing' event from the server
      socket.on('typing', (text) => {
        displayTypingIndicator(text);
      });

      // Handle 'stop typing' event from the server
      socket.on('stop typing', () => {
        clearTypingIndicator();
      });

      // Call appUsageIndicator with activeClientsCount as an argument
      socket.on('activeClients', (activeClientsCount) => {
        appUsageIndicator(activeClientsCount);
      });

      // Define appUsageIndicator function to accept activeClientsCount as an argument
      const appUsageIndicator = (activeClientsCount) => {
        if (activeClientsCount === 2) {
          usageIndicator.textContent = `Ma and Mg are using the application.`;
        } else if(activeClientsCount === 1){
          usageIndicator.textContent = 'You are using the application alone.';
        } else if(activeClientsCount > 2){
          usageIndicator.textContent = 'Stranger is incoming to the Application';
        
        } else {
          usageIndicator.textContent = '';
        }
      };

      // Event listener to update app usage indicator based on the count of active clients
      socket.on('activeClients', (activeClientsCount) => {
        appUsageIndicator(activeClientsCount);
      });

      // Event listener for input events
      input.addEventListener('input', () => {
        if (input.value) {
          emitTypingEvent();
        } else {
          emitStopTypingEvent();
        }
      });

    // Add an event listener to the button
    document.getElementById('startButton').addEventListener('click', function() {
      // Define the predefined page address
      var predefinedPageAddress = 'https://mavid-b41c96f5db88.herokuapp.com/';

      // Redirect the user to the predefined page
      window.location.href = predefinedPageAddress;
    });

    </script>
  </body>
</html>
